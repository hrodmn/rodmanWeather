<?php

// Create connection
$sql = new mysqli('localhost', 'root', 'shasta', 'weather_database');

// Check connection
if (mysqli_connect_errno()) {
    printf("Connect failed: %s\n", mysqli_connect_error());
    exit();
  }

$query = "SELECT * FROM weatherLog WHERE datetime >= now() - INTERVAL 1 DAY;"
$result = $sql->query($query) or exit("Error code ({$sql->errno}): {$sql->error}");

$rows = array();
$table = array();
$table['cols'] = array(
		array('label' => 'datetime', 'type' => 'string'),
		array('label' => 'temperature', 'type' => 'number'),
		array('label' => 'humidity', 'type' => 'number')
);

foreach($result as $r) {

	$temp = array();

	$temp[] = array('v' => (string) $r['datetime']);
	$temp[] = array('v' => (int) $r['temperature']);
	$temp[] = array('v' => (int) $r['humidity']);
	$rows[] = array('c' => $temp);
}

$table['rows'] = $rows;

$jsonTable = json_encode($table);

$sql->close();
?>

<html>
  <head>
    <!--Load the Ajax API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript">

    // Load the Visualization API and the piechart package.
    google.load('visualization', '1', {'packages':['corechart']});

    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawChart);
    
//     var jsonData = $.ajax({
//     	  url: "weatherQuery.php",
//     	  dataType:"json",
//     	  async: false
//     	  }).responseText;
    	   
    	// Create our data table out of JSON data loaded from server.
    

    function drawChart() {

      // Create our data table out of JSON data loaded from server.
      var data = new google.visualization.DataTable(<?=$jsonData?>);
      var options = {
    		  title: 'Last 24 hours:',
              curveType: 'function',
              legend: { position: 'bottom' }
      };
      // Instantiate and draw our chart, passing in some options.
      // Do not forget to check your div ID
      var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
      chart.draw(data, options);
    }
    </script>
  </head>

  <body>
    <!--this is the div that will hold the pie chart-->
    <div id="chart_div"></div>
  </body>
</html>